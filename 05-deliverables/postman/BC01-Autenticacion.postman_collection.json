{
	"info": {
		"_postman_id": "bc01-auth-mitoga-2025",
		"name": "BC01 - Autenticaci√≥n",
		"description": "# Bounded Context: Autenticaci√≥n\n\n## Descripci√≥n\nGesti√≥n completa del ciclo de vida de autenticaci√≥n de usuarios en la plataforma MI-TOGA:\n- Registro multi-step (estudiantes y tutores)\n- Verificaci√≥n de email con OTP\n- Login con JWT + Refresh Token\n- Gesti√≥n de sesiones activas\n- Recuperaci√≥n de contrase√±a\n\n## Base URLs\n- **Desarrollo**: `http://localhost:8080`\n- **Staging**: `https://api-staging.mitoga.com`\n- **Producci√≥n**: `https://api.mitoga.com`\n\n## Arquitectura\n- **Pattern**: Hexagonal (Ports & Adapters)\n- **DDD**: Aggregate Root `Usuario`\n- **Security**: JWT (Access Token 15min + Refresh Token 7 d√≠as)\n- **Database**: PostgreSQL 17.6 (schema: `appmatch_schema.usuarios`)\n\n## Versionamiento API\n- **Versi√≥n actual**: v1\n- **Estrategia**: URL versioning (`/api/v1/...`)\n\n## ADRs Relacionados\n- [ADR-003] Estrategia JWT + OAuth2\n- [ADR-008] Validaci√≥n Bean Validation\n- [ADR-009] Redis para cache distribuido\n- [ADR-017] Rate limiting con Bucket4j\n\n---\n\n**Autor**: Equipo Backend MI-TOGA  \n**Fecha creaci√≥n**: 17 nov 2025  \n**Sprint**: Sprint 2",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "mitoga-backend-team"
	},
	"item": [
		{
			"name": "1. Registro",
			"item": [
				{
					"name": "1.1 STEP 1 - Iniciar Registro (Credenciales)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Extraer y guardar usuarioId y procesoRegistroId",
									"if (pm.response.code === 201) {",
									"    const jsonData = pm.response.json();",
									"    pm.environment.set('usuarioId', jsonData.data.usuarioId);",
									"    pm.environment.set('procesoRegistroId', jsonData.data.procesoRegistroId);",
									"    pm.environment.set('email', jsonData.data.email);",
									"    ",
									"    console.log('‚úÖ Usuario creado:', jsonData.data.usuarioId);",
									"}",
									"",
									"// Validar estructura response",
									"pm.test('Status code is 201', () => {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test('Response tiene estructura correcta', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.have.property('status', 'success');",
									"    pm.expect(jsonData.data).to.have.property('usuarioId');",
									"    pm.expect(jsonData.data).to.have.property('email');",
									"    pm.expect(jsonData.data).to.have.property('estadoCuenta', 'PENDIENTE_VERIFICACION');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "X-Client-Version",
								"value": "1.0.0",
								"description": "Versi√≥n del cliente"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"{{$randomEmail}}\",\n  \"password\": \"SecurePass123!\",\n  \"confirmPassword\": \"SecurePass123!\",\n  \"metadata\": {\n    \"ipRegistro\": \"192.168.1.100\",\n    \"userAgent\": \"PostmanRuntime/7.32.3\",\n    \"dispositivo\": \"web\",\n    \"navegador\": \"Postman\",\n    \"sistemaOperativo\": \"Windows 11\"\n  }\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/registro/estudiante/step1",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"registro",
								"estudiante",
								"step1"
							]
						},
						"description": "**HUT-001**: Registro de Estudiantes - STEP 1\n\n### Funcionalidad\nInicia el proceso de registro multi-step creando el usuario con credenciales b√°sicas.\n\n### Validaciones Backend\n- Email √∫nico (no registrado previamente)\n- Email v√°lido (RFC 5322)\n- Password ‚â• 8 caracteres\n- Password debe contener: may√∫sculas, min√∫sculas, n√∫meros\n- ConfirmPassword debe coincidir\n\n### Estado Inicial Usuario\n- `estado_cuenta`: PENDIENTE_VERIFICACION\n- `email_verificado`: false\n- `intentos_fallidos_login`: 0\n\n### Flujo Siguiente\n1. Se env√≠a OTP al email (v√°lido 10 min)\n2. Usuario debe verificar email (HUT-003)\n3. Continuar con STEP 2 (informaci√≥n personal)"
					},
					"response": []
				},
				{
					"name": "1.2 STEP 2 - Completar Informaci√≥n Personal",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const jsonData = pm.response.json();",
									"    pm.environment.set('informacionBasicaId', jsonData.data.informacionBasicaId);",
									"    console.log('‚úÖ Informaci√≥n personal guardada');",
									"}",
									"",
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Validaci√≥n edad realizada', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data).to.have.property('esMayorDeEdad');",
									"    pm.expect(jsonData.data).to.have.property('requiereResponsableLegal');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usuarioId\": \"{{usuarioId}}\",\n  \"procesoRegistroId\": \"{{procesoRegistroId}}\",\n  \"informacionPersonal\": {\n    \"primerNombre\": \"Juan\",\n    \"segundoNombre\": \"Carlos\",\n    \"primerApellido\": \"P√©rez\",\n    \"segundoApellido\": \"Garc√≠a\",\n    \"fechaNacimiento\": \"2005-03-15\",\n    \"generoId\": \"550e8400-e29b-41d4-a716-446655440000\",\n    \"tipoDocumentoId\": \"550e8400-e29b-41d4-a716-446655440001\",\n    \"numeroDocumento\": \"1234567890\",\n    \"telefono\": \"+57 310 1234567\",\n    \"paisId\": \"550e8400-e29b-41d4-a716-446655440002\",\n    \"ciudadId\": \"550e8400-e29b-41d4-a716-446655440003\",\n    \"direccion\": \"Calle 123 #45-67, Apto 301\",\n    \"codigoPostal\": \"110111\"\n  },\n  \"responsableLegal\": {\n    \"requerido\": false,\n    \"primerNombre\": null,\n    \"primerApellido\": null,\n    \"email\": null,\n    \"telefono\": null,\n    \"tipoDocumentoId\": null,\n    \"numeroDocumento\": null\n  }\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/registro/estudiante/step2",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"registro",
								"estudiante",
								"step2"
							]
						},
						"description": "**HUT-001**: Registro de Estudiantes - STEP 2\n\n### Funcionalidad\nCompleta la informaci√≥n personal del usuario (datos b√°sicos + ubicaci√≥n).\n\n### Validaciones Backend\n- Usuario debe estar en estado PENDIENTE_VERIFICACION\n- Edad ‚â• 13 a√±os (pol√≠tica COPPA)\n- Si edad < 18 a√±os ‚Üí requiere responsable legal\n- Nombres y apellidos: solo letras y espacios\n- N√∫mero documento √∫nico por tipo\n- Pa√≠s y ciudad deben existir en cat√°logo\n- Tel√©fono formato internacional (+57 310 1234567)\n\n### L√≥gica Responsable Legal\n- Si `fechaNacimiento` indica menor de edad (< 18 a√±os)\n- Campo `responsableLegal.requerido` = true\n- Todos los campos de responsableLegal son obligatorios\n\n### Flujo Siguiente\nContinuar con STEP 3 (carga de documentos)"
					},
					"response": []
				},
				{
					"name": "1.3 STEP 3 - Cargar Documentos Verificaci√≥n",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const jsonData = pm.response.json();",
									"    console.log('‚úÖ Documentos cargados:', jsonData.data.archivosSubidos.length);",
									"}",
									"",
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Archivos subidos correctamente', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.archivosSubidos.length).to.be.at.least(4);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "multipart/form-data"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "usuarioId",
									"value": "{{usuarioId}}",
									"type": "text"
								},
								{
									"key": "procesoRegistroId",
									"value": "{{procesoRegistroId}}",
									"type": "text"
								},
								{
									"key": "fotoPerfil",
									"type": "file",
									"src": "/path/to/foto-perfil.jpg"
								},
								{
									"key": "documentoFrente",
									"type": "file",
									"src": "/path/to/documento-frente.jpg"
								},
								{
									"key": "documentoReverso",
									"type": "file",
									"src": "/path/to/documento-reverso.jpg"
								},
								{
									"key": "fotoEnVivo",
									"type": "file",
									"src": "/path/to/selfie-en-vivo.jpg"
								}
							]
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/registro/estudiante/step3",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"registro",
								"estudiante",
								"step3"
							]
						},
						"description": "**HUT-001 + HUT-004**: Registro de Estudiantes - STEP 3\n\n### Funcionalidad\nCarga de documentos de verificaci√≥n de identidad (4 fotos obligatorias).\n\n### Archivos Requeridos\n1. **fotoPerfil**: Foto de perfil profesional\n2. **documentoFrente**: Documento de identidad (frontal)\n3. **documentoReverso**: Documento de identidad (reverso)\n4. **fotoEnVivo**: Selfie en vivo (validaci√≥n biom√©trica)\n\n### Validaciones Backend\n- Formatos permitidos: JPG, JPEG, PNG\n- Tama√±o m√°ximo: 5MB por archivo\n- Resoluci√≥n m√≠nima: 800x600 px\n- Detecci√≥n de duplicados (hash SHA256)\n- Almacenamiento: MinIO/S3\n\n### Storage Strategy\n- Bucket: `mitoga-verificacion-documentos`\n- Path: `{usuarioId}/{tipoArchivo}/{timestamp}_{filename}`\n- Encriptaci√≥n: AES-256\n- Retenci√≥n: 90 d√≠as post-verificaci√≥n\n\n### Flujo Siguiente\nContinuar con STEP 4 (confirmaci√≥n y aceptaci√≥n t√©rminos)"
					},
					"response": []
				},
				{
					"name": "1.4 STEP 4 - Confirmar Registro",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const jsonData = pm.response.json();",
									"    pm.environment.set('perfilEstudianteId', jsonData.data.perfilEstudianteId);",
									"    console.log('‚úÖ Registro completado exitosamente');",
									"}",
									"",
									"pm.test('Status code is 201', () => {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test('Perfil estudiante creado', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data).to.have.property('perfilEstudianteId');",
									"    pm.expect(jsonData.data.estadoPerfil).to.equal('PENDIENTE_APROBACION');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usuarioId\": \"{{usuarioId}}\",\n  \"procesoRegistroId\": \"{{procesoRegistroId}}\",\n  \"aceptaciones\": {\n    \"aceptaTerminosYCondiciones\": true,\n    \"aceptaPoliticaPrivacidad\": true,\n    \"aceptaHabeasData\": true,\n    \"aceptaUsoDatosPersonales\": true,\n    \"ipAceptacion\": \"192.168.1.100\",\n    \"fechaAceptacion\": \"{{$isoTimestamp}}\"\n  },\n  \"preferenciasComunicacion\": {\n    \"recibirEmailsPromocionales\": true,\n    \"recibirNotificacionesPush\": true,\n    \"recibirSMS\": false\n  }\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/registro/estudiante/step4",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"registro",
								"estudiante",
								"step4"
							]
						},
						"description": "**HUT-001**: Registro de Estudiantes - STEP 4 (FINAL)\n\n### Funcionalidad\nFinaliza el proceso de registro aceptando t√©rminos y condiciones.\n\n### Validaciones Backend\n- Todos los campos de aceptaci√≥n deben ser `true`\n- Usuario debe haber completado STEP 1, 2 y 3\n- Proceso de registro debe estar en estado COMPLETO\n\n### Acciones Backend\n1. Crear perfil de estudiante (tabla `perfil_informacion_basica`)\n2. Cambiar estado a `PENDIENTE_APROBACION`\n3. Crear registro de aceptaciones legales (auditor√≠a)\n4. Enviar email de bienvenida\n5. Notificar a equipo admin para aprobaci√≥n manual\n\n### Estados Finales\n- Usuario: `ACTIVO` (puede hacer login)\n- Perfil Estudiante: `PENDIENTE_APROBACION` (funcionalidad limitada)\n\n### Funcionalidad Disponible Post-Registro\n- ‚úÖ Login y navegaci√≥n b√°sica\n- ‚úÖ Editar perfil\n- ‚úÖ Ver cat√°logo de tutores (solo lectura)\n- ‚ùå Reservar tutor√≠as (requiere aprobaci√≥n)\n- ‚ùå Realizar pagos (requiere aprobaci√≥n)"
					},
					"response": []
				}
			],
			"description": "Flujo completo de registro multi-step para estudiantes.\n\n### Secuencia de Pasos\n1. **STEP 1**: Credenciales (email + password)\n2. **STEP 2**: Informaci√≥n personal + responsable legal (si aplica)\n3. **STEP 3**: Carga de 4 documentos (foto perfil, documento frente/reverso, selfie)\n4. **STEP 4**: Aceptaci√≥n t√©rminos y confirmaci√≥n\n\n### Pol√≠tica de Rollback\nSi el usuario abandona el proceso:\n- STEP 1 solo ‚Üí Usuario soft-deleted tras 7 d√≠as\n- STEP 2-3 completos ‚Üí Proceso guardado 30 d√≠as, puede retomar\n\n### HUTs Relacionados\n- **HUT-001**: Registro Estudiantes\n- **HUT-002**: Registro Tutores (similar flow)\n- **HUT-004**: Gesti√≥n archivos MinIO/S3"
		},
		{
			"name": "2. Verificaci√≥n Email (OTP)",
			"item": [
				{
					"name": "2.1 Verificar C√≥digo OTP",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const jsonData = pm.response.json();",
									"    pm.environment.set('accessToken', jsonData.data.tokens.accessToken);",
									"    pm.environment.set('refreshToken', jsonData.data.tokens.refreshToken);",
									"    console.log('‚úÖ Email verificado, tokens guardados');",
									"}",
									"",
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Tokens JWT generados', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.tokens).to.have.property('accessToken');",
									"    pm.expect(jsonData.data.tokens).to.have.property('refreshToken');",
									"    pm.expect(jsonData.data.tokens.expiresIn).to.equal(900);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usuarioId\": \"{{usuarioId}}\",\n  \"email\": \"{{email}}\",\n  \"codigoOTP\": \"123456\",\n  \"metadata\": {\n    \"ipAddress\": \"192.168.1.100\",\n    \"userAgent\": \"PostmanRuntime/7.32.3\",\n    \"dispositivo\": \"web\"\n  }\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/verificar-email",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"verificar-email"
							]
						},
						"description": "**HUT-003**: Verificaci√≥n de Email con OTP\n\n### Funcionalidad\nVerifica el email del usuario mediante c√≥digo OTP de 6 d√≠gitos.\n\n### Flujo OTP\n1. Usuario recibe email con c√≥digo al completar STEP 1\n2. C√≥digo v√°lido por 10 minutos\n3. M√°ximo 3 intentos fallidos\n4. Tras 3 fallos ‚Üí bloqueo temporal 15 minutos\n\n### Validaciones Backend\n- C√≥digo OTP debe coincidir con el almacenado en Redis\n- TTL no expirado (< 10 min desde env√≠o)\n- Usuario no bloqueado por intentos fallidos\n- Estado usuario = PENDIENTE_VERIFICACION\n\n### Acciones Backend (√©xito)\n1. Cambiar `email_verificado` = true\n2. Cambiar `estado_cuenta` = ACTIVO\n3. Resetear `intentos_fallidos_login` = 0\n4. Generar par de tokens JWT (access + refresh)\n5. Eliminar OTP de Redis\n6. Registrar evento `EmailVerificadoEvent`\n\n### Tokens Generados\n- **Access Token**: V√°lido 15 min (900s)\n- **Refresh Token**: V√°lido 7 d√≠as (604800s)\n- **Algoritmo**: HMAC-SHA256\n- **Claims**: usuarioId, email, rol, permisos"
					},
					"response": []
				},
				{
					"name": "2.2 Reenviar C√≥digo OTP",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Cooldown respetado', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data).to.have.property('proximoReenvioEn');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usuarioId\": \"{{usuarioId}}\",\n  \"email\": \"{{email}}\",\n  \"metadata\": {\n    \"ipAddress\": \"192.168.1.100\",\n    \"userAgent\": \"PostmanRuntime/7.32.3\",\n    \"dispositivo\": \"web\"\n  }\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/reenviar-otp",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"reenviar-otp"
							]
						},
						"description": "**HUT-003**: Reenviar C√≥digo OTP\n\n### Funcionalidad\nReenv√≠a un nuevo c√≥digo OTP si el anterior expir√≥ o se perdi√≥.\n\n### Validaciones Backend\n- Cooldown de 60 segundos entre reenv√≠os\n- M√°ximo 5 reenv√≠os por proceso de registro\n- Usuario debe estar en PENDIENTE_VERIFICACION\n- No debe estar bloqueado\n\n### L√≥gica Rate Limiting\n- Key Redis: `otp:reenvio:{usuarioId}`\n- TTL: 60 segundos\n- Si key existe ‚Üí retornar 429 Too Many Requests\n\n### Acciones Backend\n1. Generar nuevo c√≥digo OTP (6 d√≠gitos)\n2. Invalidar c√≥digo anterior en Redis\n3. Guardar nuevo c√≥digo con TTL 10 min\n4. Enviar email con plantilla Thymeleaf\n5. Incrementar contador reenv√≠os\n6. Establecer cooldown 60s"
					},
					"response": []
				}
			],
			"description": "Verificaci√≥n de email mediante One-Time Password (OTP).\n\n### Caracter√≠sticas\n- C√≥digo de 6 d√≠gitos num√©ricos\n- V√°lido 10 minutos (TTL en Redis)\n- M√°ximo 3 intentos fallidos\n- Cooldown 60s entre reenv√≠os\n- Bloqueo temporal tras fallos repetidos\n\n### Seguridad\n- OTP almacenado en Redis (no en DB)\n- Rate limiting por IP y usuario\n- Logging de todos los intentos\n- Email enmascarado en responses (est***nte@email.com)\n\n### HUT Relacionado\n**HUT-003**: Verificaci√≥n Email con OTP"
		},
		{
			"name": "3. Login & Tokens",
			"item": [
				{
					"name": "3.1 Login (Access + Refresh Token)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const jsonData = pm.response.json();",
									"    pm.environment.set('accessToken', jsonData.data.tokens.accessToken);",
									"    pm.environment.set('refreshToken', jsonData.data.tokens.refreshToken);",
									"    pm.environment.set('sesionId', jsonData.data.sesion.sesionId);",
									"    ",
									"    // Auto-configurar Authorization header para pr√≥ximas requests",
									"    pm.request.headers.add({",
									"        key: 'Authorization',",
									"        value: `Bearer ${jsonData.data.tokens.accessToken}`",
									"    });",
									"    ",
									"    console.log('‚úÖ Login exitoso, tokens guardados');",
									"}",
									"",
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Estructura completa de tokens', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.tokens).to.have.all.keys(",
									"        'accessToken', 'refreshToken', 'tokenType', 'expiresIn', 'refreshExpiresIn'",
									"    );",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"{{email}}\",\n  \"password\": \"SecurePass123!\",\n  \"dispositivo\": {\n    \"tipo\": \"WEB\",\n    \"navegador\": \"Chrome 120\",\n    \"sistemaOperativo\": \"Windows 11\",\n    \"ip\": \"192.168.1.100\",\n    \"userAgent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\"\n  },\n  \"recordarme\": true\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/login",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"login"
							]
						},
						"description": "**HUT-006**: Login con JWT\n\n### Funcionalidad\nAutenticaci√≥n de usuario con email y contrase√±a, generando par de tokens JWT.\n\n### Validaciones Backend\n- Email debe existir y estar verificado\n- Password debe coincidir (bcrypt)\n- Usuario debe estar en estado ACTIVO\n- No debe estar bloqueado por intentos fallidos\n\n### L√≥gica Intentos Fallidos\n- Tras fallo: incrementar `intentos_fallidos_login`\n- Si intentos ‚â• 5 ‚Üí cambiar estado a BLOQUEADO\n- Bloqueo temporal: 15 minutos\n- Tras login exitoso: resetear intentos a 0\n\n### Gesti√≥n de Sesiones\n- Se crea registro en tabla `sesiones_activas`\n- M√°ximo 5 sesiones concurrentes por usuario\n- Si l√≠mite alcanzado ‚Üí cerrar sesi√≥n m√°s antigua\n- Tracking: IP, dispositivo, ubicaci√≥n (GeoIP)\n\n### Tokens JWT\n- **Access Token**: 15 min (claims: usuarioId, email, rol)\n- **Refresh Token**: 7 d√≠as (claims: usuarioId, sesionId, jti)\n- **Token Rotation**: Cada refresh genera nuevo par\n- **Storage**: Refresh tokens en Redis (blacklist al logout)\n\n### Response Data\n- Usuario: id, email, nombre, rol, foto perfil\n- Tokens: access, refresh, expiraci√≥n\n- Sesi√≥n: id, dispositivo, ubicaci√≥n, fecha\n- Navegaci√≥n: URLs sugeridas (dashboard, perfil)"
					},
					"response": []
				},
				{
					"name": "3.2 Refresh Token (Renovar Access Token)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const jsonData = pm.response.json();",
									"    pm.environment.set('accessToken', jsonData.data.accessToken);",
									"    pm.environment.set('refreshToken', jsonData.data.refreshToken);",
									"    console.log('‚úÖ Tokens renovados (rotation)');",
									"}",
									"",
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Nuevo par de tokens generado', () => {",
									"    const jsonData = pm.response.json();",
									"    const oldAccessToken = pm.environment.get('accessToken');",
									"    const oldRefreshToken = pm.environment.get('refreshToken');",
									"    ",
									"    pm.expect(jsonData.data.accessToken).to.not.equal(oldAccessToken);",
									"    pm.expect(jsonData.data.refreshToken).to.not.equal(oldRefreshToken);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"refreshToken\": \"{{refreshToken}}\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/refresh",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"refresh"
							]
						},
						"description": "**HUT-006**: Refresh Token Rotation\n\n### Funcionalidad\nRenueva el Access Token usando el Refresh Token, implementando token rotation.\n\n### Validaciones Backend\n- Refresh token debe ser v√°lido (firma HMAC-SHA256)\n- No debe estar en blacklist de Redis\n- No debe estar expirado (< 7 d√≠as)\n- Sesi√≥n asociada debe estar activa\n\n### Token Rotation Strategy\n1. Validar refresh token actual\n2. Generar NUEVO access token (15 min)\n3. Generar NUEVO refresh token (7 d√≠as)\n4. Invalidar refresh token anterior (blacklist Redis)\n5. Actualizar `ultima_actividad` en sesi√≥n\n\n### Seguridad\n- Previene replay attacks (token usado 1 sola vez)\n- Rotaci√≥n autom√°tica en cada refresh\n- Sliding session (extiende 7 d√≠as desde √∫ltimo refresh)\n- Detecci√≥n de tokens robados (m√∫ltiples refreshes simult√°neos)\n\n### Manejo de Errores\n- **401**: Refresh token inv√°lido ‚Üí Forzar re-login\n- **403**: Token en blacklist ‚Üí Sesi√≥n cerrada previamente\n- **410**: Token expirado ‚Üí Re-autenticaci√≥n requerida"
					},
					"response": []
				},
				{
					"name": "3.3 Logout (Cerrar Sesi√≥n)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    pm.environment.unset('accessToken');",
									"    pm.environment.unset('refreshToken');",
									"    pm.environment.unset('sesionId');",
									"    console.log('‚úÖ Sesi√≥n cerrada, tokens eliminados');",
									"}",
									"",
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{accessToken}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"refreshToken\": \"{{refreshToken}}\",\n  \"cerrarTodasLasSesiones\": false\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/logout",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"logout"
							]
						},
						"description": "**HUT-006**: Logout Seguro\n\n### Funcionalidad\nCierra la sesi√≥n actual invalidando los tokens JWT.\n\n### Acciones Backend\n1. Agregar refresh token a blacklist de Redis\n2. Eliminar sesi√≥n de `sesiones_activas`\n3. Registrar logout en audit log\n4. Actualizar `fecha_ultimo_acceso` del usuario\n\n### Opciones de Cierre\n- **cerrarTodasLasSesiones = false**: Solo cierra sesi√≥n actual\n- **cerrarTodasLasSesiones = true**: Cierra todas las sesiones del usuario (√∫til si detecta acceso no autorizado)\n\n### Blacklist en Redis\n- Key: `blacklist:rt:{jti}`\n- TTL: Mismo que el refresh token (7 d√≠as)\n- Consulta r√°pida en middleware JWT\n\n### Eventos Disparados\n- `UsuarioLogoutEvent` (domain event)\n- Email de notificaci√≥n (si cierre masivo)"
					},
					"response": []
				},
				{
					"name": "3.4 Listar Sesiones Activas",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Lista de sesiones devuelta', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.sesiones).to.be.an('array');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{accessToken}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/sesiones",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"sesiones"
							]
						},
						"description": "**HUT-006**: Gesti√≥n de Sesiones\n\n### Funcionalidad\nLista todas las sesiones activas del usuario autenticado.\n\n### Informaci√≥n por Sesi√≥n\n- **sesionId**: UUID √∫nico\n- **dispositivo**: Tipo, navegador, SO\n- **ubicacion**: Ciudad, pa√≠s (GeoIP)\n- **ipAddress**: IP origen (enmascarada: 192.168.***.***)\n- **fechaCreacion**: Timestamp del login\n- **ultimaActividad**: Timestamp √∫ltimo request\n- **esActual**: Boolean (sesi√≥n del token actual)\n\n### Casos de Uso\n- Ver d√≥nde est√° logueado el usuario\n- Detectar sesiones sospechosas\n- Cerrar sesiones remotas desde UI\n\n### L√≠mites\n- M√°ximo 5 sesiones concurrentes\n- Sesiones inactivas > 30 d√≠as se cierran autom√°ticamente"
					},
					"response": []
				},
				{
					"name": "3.5 Cerrar Sesi√≥n Espec√≠fica",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{accessToken}}",
									"type": "string"
								}
							]
						},
						"method": "DELETE",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/sesiones/:sesionId",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"sesiones",
								":sesionId"
							],
							"variable": [
								{
									"key": "sesionId",
									"value": "{{sesionId}}"
								}
							]
						},
						"description": "**HUT-006**: Cerrar Sesi√≥n Remota\n\n### Funcionalidad\nCierra una sesi√≥n espec√≠fica (√∫til para revocar acceso en dispositivo perdido).\n\n### Validaciones\n- Sesi√≥n debe pertenecer al usuario autenticado\n- No se puede cerrar la sesi√≥n actual (usar logout)\n\n### Acciones Backend\n1. Blacklist refresh token de la sesi√≥n\n2. Eliminar registro de `sesiones_activas`\n3. Enviar notificaci√≥n al dispositivo (si push habilitado)"
					},
					"response": []
				}
			],
			"description": "Autenticaci√≥n JWT con estrategia de token rotation.\n\n### Caracter√≠sticas\n- **Access Token**: 15 minutos (claims ligeros)\n- **Refresh Token**: 7 d√≠as (sliding session)\n- **Token Rotation**: Nuevo par en cada refresh\n- **Blacklist**: Redis para tokens revocados\n- **Sesiones**: M√°ximo 5 concurrentes\n\n### Seguridad\n- bcrypt para passwords (cost factor 12)\n- HMAC-SHA256 para firma JWT\n- Rate limiting (5 intentos/5min)\n- Device fingerprinting\n- GeoIP tracking\n\n### HUT Relacionado\n**HUT-006**: Login + Refresh Token"
		},
		{
			"name": "4. Recuperaci√≥n Contrase√±a",
			"item": [
				{
					"name": "4.1 Solicitar Recuperaci√≥n (Enviar Token)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Email enviado', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data).to.have.property('emailEnviadoA');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"{{email}}\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/recuperar-password",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"recuperar-password"
							]
						},
						"description": "### Funcionalidad\nInicia el proceso de recuperaci√≥n de contrase√±a enviando token por email.\n\n### Validaciones Backend\n- Email debe existir en la base de datos\n- Usuario debe estar ACTIVO (no bloqueado/eliminado)\n- Rate limiting: 1 solicitud cada 5 minutos por email\n\n### L√≥gica Token Recuperaci√≥n\n- Generar token UUID aleatorio (128 bits)\n- TTL: 24 horas\n- Guardar en campo `token_recuperacion_password`\n- Guardar timestamp en `fecha_token_recuperacion`\n\n### Email Enviado\n- Plantilla Thymeleaf responsive\n- Link: `https://mitoga.com/reset-password?token={token}`\n- Mensaje: \"Si no solicitaste esto, ignora este email\"\n- V√°lido por: 24 horas\n\n### Seguridad\n- No revelar si email existe (siempre retornar 200)\n- Logging de todas las solicitudes\n- Bloqueo tras 3 solicitudes/hora por IP"
					},
					"response": []
				},
				{
					"name": "4.2 Validar Token Recuperaci√≥n",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Token v√°lido', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.esValido).to.be.true;",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/validar-token-recuperacion?token=abc123xyz789",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"validar-token-recuperacion"
							],
							"query": [
								{
									"key": "token",
									"value": "abc123xyz789"
								}
							]
						},
						"description": "### Funcionalidad\nValida si el token de recuperaci√≥n es v√°lido antes de mostrar formulario.\n\n### Validaciones Backend\n- Token debe existir en DB\n- No debe estar expirado (< 24 horas)\n- Usuario asociado debe estar ACTIVO\n- Token no debe haber sido usado (se invalida tras cambio exitoso)\n\n### Response\n- `esValido`: boolean\n- `email`: Enmascarado (mar***ia@email.com)\n- `expiraEn`: Timestamp ISO 8601\n- `minutosRestantes`: N√∫mero\n\n### Casos de Error\n- Token no existe ‚Üí 404\n- Token expirado ‚Üí 410 Gone\n- Token ya usado ‚Üí 409 Conflict"
					},
					"response": []
				},
				{
					"name": "4.3 Restablecer Contrase√±a (Nueva Password)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status code is 200', () => {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Contrase√±a actualizada', () => {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.message).to.include('actualizada');",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"token\": \"abc123xyz789\",\n  \"nuevaPassword\": \"NewSecurePass456!\",\n  \"confirmPassword\": \"NewSecurePass456!\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/auth/restablecer-password",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"auth",
								"restablecer-password"
							]
						},
						"description": "### Funcionalidad\nEstablece la nueva contrase√±a usando el token de recuperaci√≥n.\n\n### Validaciones Backend\n- Token v√°lido y no expirado\n- Nueva password cumple pol√≠tica (8+ chars, complejidad)\n- Nueva password ‚â† √∫ltima 3 passwords (prevenir reuso)\n- confirmPassword debe coincidir\n\n### Acciones Backend\n1. Validar token (mismo flujo que validar-token)\n2. Hashear nueva password con bcrypt (cost 12)\n3. Actualizar `password_hash` en DB\n4. Invalidar token: `token_recuperacion_password` = NULL\n5. Resetear `intentos_fallidos_login` = 0\n6. Si estaba BLOQUEADO ‚Üí cambiar a ACTIVO\n7. Cerrar todas las sesiones activas (seguridad)\n8. Blacklist todos los refresh tokens en Redis\n9. Enviar email de confirmaci√≥n\n10. Registrar evento `PasswordCambiadoEvent`\n\n### Pol√≠tica de Seguridad\n- No permitir contrase√±as comunes (rockyou.txt)\n- Verificar contra Have I Been Pwned API\n- Forzar re-login en todos los dispositivos\n- Notificar cambio a email secundario (si existe)"
					},
					"response": []
				}
			],
			"description": "Flujo de recuperaci√≥n de contrase√±a mediante token por email.\n\n### Secuencia\n1. Usuario solicita recuperaci√≥n (ingresa email)\n2. Sistema env√≠a email con link + token (v√°lido 24h)\n3. Usuario hace click en link\n4. Frontend valida token (GET validar-token)\n5. Usuario ingresa nueva contrase√±a\n6. Sistema actualiza password e invalida token\n7. Sesiones existentes son cerradas (forzar re-login)\n\n### Seguridad\n- Token √∫nico de un solo uso\n- TTL 24 horas\n- Rate limiting por IP y email\n- Forzar cierre de sesiones\n- Notificaci√≥n por email\n\n### Pol√≠tica Password\n- M√≠nimo 8 caracteres\n- Al menos 1 may√∫scula, 1 min√∫scula, 1 n√∫mero\n- No puede ser igual a √∫ltimas 3 passwords\n- Validaci√≥n contra pwned passwords"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Pre-request Script Global",
					"console.log('üîÑ Request a:', pm.request.url.toString());",
					"",
					"// Inyectar timestamp si es necesario",
					"if (!pm.request.body || !pm.request.body.raw) {",
					"    return;",
					"}",
					"",
					"const body = JSON.parse(pm.request.body.raw);",
					"if (body.metadata && !body.metadata.timestamp) {",
					"    body.metadata.timestamp = new Date().toISOString();",
					"    pm.request.body.raw = JSON.stringify(body, null, 2);",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Test Script Global",
					"",
					"// Validar siempre que haya response",
					"pm.test('Response time < 2000ms', () => {",
					"    pm.expect(pm.response.responseTime).to.be.below(2000);",
					"});",
					"",
					"// Si es error, mostrar detalle",
					"if (pm.response.code >= 400) {",
					"    const jsonData = pm.response.json();",
					"    console.error('‚ùå Error:', jsonData.message);",
					"    if (jsonData.data) {",
					"        console.error('Detalle:', jsonData.data);",
					"    }",
					"}",
					"",
					"// Validar estructura standard response (si 2xx)",
					"if (pm.response.code >= 200 && pm.response.code < 300) {",
					"    pm.test('Response tiene estructura est√°ndar', () => {",
					"        const jsonData = pm.response.json();",
					"        pm.expect(jsonData).to.have.property('status');",
					"        pm.expect(jsonData).to.have.property('timestamp');",
					"    });",
					"}"
				]
			}
		}
	],
	"variable": [
		{
			"key": "baseUrl",
			"value": "http://localhost:8080",
			"type": "string"
		}
	]
}
