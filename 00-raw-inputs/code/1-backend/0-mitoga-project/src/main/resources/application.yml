spring:
  application:
    name: mitoga_project  # Debe coincidir EXACTAMENTE con el path en Vault
  
  # Import Vault configuration BEFORE application context loads
  config:
    import: vault://
  
  # Configuración HashiCorp Vault para gestión centralizada de secrets
  cloud:
    vault:
      enabled: ${CONFIG_VAULT_ENABLED:true}
      uri: http://192.168.18.126:30200
      authentication: approle
      app-role:
        role-id: 2437e31a-1c9e-65a6-04ae-21423aab39d9
        secret-id: 97b7fdd9-0bc4-c2e2-637b-99f29a731fc5
        app-role-path: mitoga_approle
      kv:
        enabled: true
        backend: mitoga-secrets
        application-name: mitoga_project  # Sobreescribe el default-context
      fail-fast: false  # No fallar si Vault no está disponible
  
  datasource:
    # Valores obtenidos desde HashiCorp Vault en runtime (con fallback local)
    url: ${secret.database.url:jdbc:postgresql://localhost:5432/mitoga_db}
    username: ${secret.database.username:postgres}
    password: ${secret.database.password:postgres}
    driver-class-name: ${secret.database.driver:org.postgresql.Driver}
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  
  jpa:
    hibernate:
      ddl-auto: none  # Deshabilitado - La BD ya existe con su schema definido
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true
    show-sql: false
  
  flyway:
    enabled: false  # Deshabilitado temporalmente - Las tablas ya existen en la BD
    baseline-on-migrate: true
    baseline-version: 0
    locations: classpath:db/migration
    schemas: public
    validate-on-migrate: false
  
  # Configuración de email (valores desde Vault)
  mail:
    host: ${secret.smtp.host}
    port: ${secret.smtp.port}
    username: ${secret.smtp.username}
    password: ${secret.smtp.password}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
          ssl:
            trust: "*"
    default-encoding: UTF-8
  
  # File Upload
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB
      enabled: true
  
  # Jackson JSON
  jackson:
    serialization:
      write-dates-as-timestamps: false
      indent-output: true
    time-zone: UTC
    default-property-inclusion: non_null
  
  # Configuración Redis (valores desde Vault)
  data:
    redis:
      host: ${secret.redis_host}
      port: ${secret.redis_port}
      password: ${secret.redis_password}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

# ========== JWT Configuration (managed by Vault) ==========
jwt:
  secret: ${secret.jwt.secret}
  access-token-expiration-minutes: ${secret.jwt.access-expiration-minutes:480} # 8 horas default
  refresh-token-expiration-days: ${secret.jwt.refresh-expiration-days:30} # 30 días default
  issuer: zns-method
  audience: mitoga-app

# ========== OAuth 2.0 Configuration (managed by Vault) ==========
oauth:
  google:
    client-id: ${secret.oauth.google.client-id}
    client-secret: ${secret.oauth.google.client-secret}
    redirect-uri: ${secret.oauth.google.redirect-uri:http://localhost:8080/api/v1/auth/oauth/callback/google}
    authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
    token-uri: https://oauth2.googleapis.com/token
    user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
    scopes: openid,profile,email
  
  facebook:
    client-id: ${secret.oauth.facebook.client-id}
    client-secret: ${secret.oauth.facebook.client-secret}
    redirect-uri: ${secret.oauth.facebook.redirect-uri:http://localhost:8080/api/v1/auth/oauth/callback/facebook}
    authorization-uri: https://www.facebook.com/v12.0/dialog/oauth
    token-uri: https://graph.facebook.com/v12.0/oauth/access_token
    user-info-uri: https://graph.facebook.com/me?fields=id,name,email,picture
    scopes: email,public_profile
  
  microsoft:
    client-id: ${secret.oauth.microsoft.client-id}
    client-secret: ${secret.oauth.microsoft.client-secret}
    redirect-uri: ${secret.oauth.microsoft.redirect-uri:http://localhost:8080/api/v1/auth/oauth/callback/microsoft}
    authorization-uri: https://login.microsoftonline.com/common/oauth2/v2.0/authorize
    token-uri: https://login.microsoftonline.com/common/oauth2/v2.0/token
    user-info-uri: https://graph.microsoft.com/v1.0/me
    scopes: openid,profile,email,User.Read
  
  github:
    client-id: ${secret.oauth.github.client-id}
    client-secret: ${secret.oauth.github.client-secret}
    redirect-uri: ${secret.oauth.github.redirect-uri:http://localhost:8080/api/v1/auth/oauth/callback/github}
    authorization-uri: https://github.com/login/oauth/authorize
    token-uri: https://github.com/login/oauth/access_token
    user-info-uri: https://api.github.com/user
    scopes: read:user,user:email
  
  apple:
    client-id: ${secret.oauth.apple.client-id}
    client-secret: ${secret.oauth.apple.client-secret}
    redirect-uri: ${secret.oauth.apple.redirect-uri:http://localhost:8080/api/v1/auth/oauth/callback/apple}
    authorization-uri: https://appleid.apple.com/auth/authorize
    token-uri: https://appleid.apple.com/auth/token
    user-info-uri: https://appleid.apple.com/auth/userinfo
    scopes: name,email
    team-id: ${secret.oauth.apple.team-id}
    key-id: ${secret.oauth.apple.key-id}

# ========== AWS S3 Configuration (managed by Vault) ==========
aws:
  s3:
    access-key-id: ${secret.aws.s3.access-key-id}
    secret-access-key: ${secret.aws.s3.secret-access-key}
    region: ${secret.aws.s3.region:us-east-1}
    bucket-name: ${secret.aws.s3.bucket-name:zns-method-files}
    max-file-size: 10485760 # 10MB
    allowed-image-types: jpg,jpeg,png,webp
    allowed-document-types: pdf,doc,docx
    
    estudiantes:
      prefix: estudiantes
      max-size: 5242880 # 5MB
      allowed-types: jpg,jpeg,png,pdf
    
    tutores:
      prefix: tutores
      max-size: 10485760 # 10MB
      allowed-types: jpg,jpeg,png,pdf,doc,docx,mp4

# ========== Email Templates Configuration ==========
email:
  from: ${secret.smtp.from:noreply@zns-method.com}
  from-name: ZNS Method - Mitoga
  login-url: ${secret.smtp.login-url:https://app.zns-method.com/login}
  support-email: soporte@zns-method.com
  
  templates:
    verificacion: classpath:templates/email/verificacion.html
    bienvenida: classpath:templates/email/bienvenida.html
    password-reset: classpath:templates/email/password-reset.html
    oauth-vinculado: classpath:templates/email/oauth-vinculado.html
    cuenta-bloqueada: classpath:templates/email/cuenta-bloqueada.html

# ========== Token Configuration ==========
token:
  verification:
    expiration-minutes: 5
    max-attempts: 3
    code-length: 6
  
  password-reset:
    expiration-minutes: 15
    max-attempts: 3

# ========== CORS Configuration ==========
cors:
  allowed-origins: ${secret.cors.allowed-origins:http://localhost:3000,http://localhost:5173}
  allowed-methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
  allowed-headers: "*"
  exposed-headers: Authorization,Content-Type
  allow-credentials: true
  max-age: 3600

# ========== Rate Limiting ==========
rate-limit:
  enabled: true
  requests-per-minute: 60
  requests-per-hour: 1000
  
  endpoints:
    registro: 5
    login: 10
    refresh: 20
    verificacion: 3

server:
  port: ${secret.server.port:8082}
  error:
    include-message: always
    include-stacktrace: never
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024

# Actuator Endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      # Configurar componentes como UP/DOWN según disponibilidad
      group:
        readiness:
          include: db  # Solo DB es crítico para readiness
        liveness:
          include: ping  # Liveness solo verifica que la app responda
  # Configurar Redis como opcional (no afecta el estado general)
  health:
    redis:
      enabled: true  # Habilitar health check pero no crítico
    defaults:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# Logging
logging:
  level:
    root: INFO
    com.mitoga: DEBUG
    org.springframework.web: INFO
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# SpringDoc OpenAPI (Swagger)
springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
  show-actuator: true

# JWT Configuration - BC Autenticación
mitoga:
  jwt:
    secret: ${SECRET_JWT_KEY:mi-clave-secreta-super-segura-para-desarrollo-local-2025}
    access-token-expiration-minutes: 480  # 8 horas
    refresh-token-expiration-days: 30
